<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2D Racing Minimal Fix</title>
<style>
  body, html {
    margin:0; padding:0; height:100%;
    display:flex; justify-content:center; align-items:center;
    background:#121212; color:#fff; font-family:sans-serif;
  }
  #login, #game, #leaderboard {
    width: 90vw; max-width: 400px;
    background:#1e1e1e; border-radius:10px;
    padding:20px; box-sizing:border-box;
    text-align:center;
    display:none;
  }
  #login.active, #game.active, #leaderboard.active { display:block; }
  input {
    width: 80%; padding:10px; font-size:16px;
    margin-bottom:10px; border:none; border-radius:5px;
  }
  button {
    background:#ff9800; border:none; padding:12px 20px;
    font-size:18px; cursor:pointer; border-radius:5px;
    user-select:none;
  }
  #score {
    margin:10px 0;
    font-size:20px;
  }
  canvas {
    display:block;
    margin: 0 auto 10px;
    background:#444;
    border-radius:10px;
    width:100%;
    max-width:360px;
    height:480px;
  }
  ul {
    list-style:none; padding:0; max-height:250px;
    overflow-y:auto; text-align:left; margin:10px 0 0 0;
  }
  li {
    padding:6px; border-bottom:1px solid #555;
    font-size:14px;
  }
  .note {
    font-size:12px;
    color:#aaa;
    margin-top:10px;
  }
  .controls {
    margin: 10px 0;
    display:flex; justify-content:center; gap:20px;
  }
  .btn {
    flex:1;
    font-size: 24px;
    padding: 12px 0;
    border-radius: 8px;
  }
</style>
</head>
<body>

<div id="login" class="active">
  <h2>üöó Enter Name</h2>
  <input id="username" maxlength="15" placeholder="Your name (2-15 chars)" />
  <button id="loginBtn">Play</button>
  <p class="note">‚ö†Ô∏è This game might get updates. Code mostly in Russian. Good luck!</p>
</div>

<div id="game">
  <h2>üèéÔ∏è 2D Racing</h2>
  <canvas id="gameCanvas" width="360" height="480"></canvas>
  <div id="score">Score: 0</div>
  <div class="controls">
    <button id="btnLeft" class="btn">‚óÄ</button>
    <button id="btnRight" class="btn">‚ñ∂</button>
  </div>
  <button id="finishBtn">Finish Game</button>
</div>

<div id="leaderboard">
  <h2>üèÜ Leaderboard</h2>
  <ul id="leaderboardList"></ul>
  <button id="playAgainBtn">Play Again</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, get, query, orderByChild, limitToLast } 
  from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDWvf8CE6jKgb61h6UIExc5pnunesu1mAc",
  authDomain: "race-2d-leaderboard.firebaseapp.com",
  databaseURL: "https://race-2d-leaderboard-default-rtdb.firebaseio.com",
  projectId: "race-2d-leaderboard",
  storageBucket: "race-2d-leaderboard.appspot.com",
  messagingSenderId: "718098667620",
  appId: "1:718098667620:web:b106d6453f903101eb2771",
  measurementId: "G-1QV2S5S3DF"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const loginDiv = document.getElementById('login');
const gameDiv = document.getElementById('game');
const leaderboardDiv = document.getElementById('leaderboard');
const usernameInput = document.getElementById('username');
const loginBtn = document.getElementById('loginBtn');
const finishBtn = document.getElementById('finishBtn');
const playAgainBtn = document.getElementById('playAgainBtn');
const leaderboardList = document.getElementById('leaderboardList');
const scoreDiv = document.getElementById('score');
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let username = '';
let score = 0;
let animationId;
let gameRunning = false;

const car = { x: 165, y: 400, width: 30, height: 50, speedX: 0 };
const road = { leftX: 40, rightX: 320 };
const obstacles = [];
const obstacleWidth = 40;
const obstacleHeight = 20;
let lastObstacleSpawn = 0;

const keys = {};
window.addEventListener('keydown', e => { if(gameRunning) keys[e.key] = true; });
window.addEventListener('keyup', e => { if(gameRunning) keys[e.key] = false; });

const btnLeft = document.getElementById("btnLeft");
const btnRight = document.getElementById("btnRight");
let touchLeft = false;
let touchRight = false;

btnLeft.addEventListener("touchstart", ()=> touchLeft = true);
btnLeft.addEventListener("touchend", ()=> touchLeft = false);
btnRight.addEventListener("touchstart", ()=> touchRight = true);
btnRight.addEventListener("touchend", ()=> touchRight = false);

function spawnObstacle() {
  const x = Math.random() * (road.rightX - road.leftX - obstacleWidth) + road.leftX;
  obstacles.push({ x, y: -obstacleHeight, width: obstacleWidth, height: obstacleHeight });
}

function rectsCollide(r1, r2) {
  return !(r2.x > r1.x + r1.width || r2.x + r2.width < r1.x || r2.y > r1.y + r1.height || r2.y + r2.height < r1.y);
}

function gameLoop(timestamp=0) {
  if (!gameRunning) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw road
  ctx.fillStyle = '#555';
  ctx.fillRect(road.leftX, 0, road.rightX - road.leftX, canvas.height);

  // Road center lines
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 4;
  for(let y = (timestamp / 10) % 40; y < canvas.height; y += 40) {
    ctx.beginPath();
    ctx.moveTo(canvas.width/2, y);
    ctx.lineTo(canvas.width/2, y+20);
    ctx.stroke();
  }

  // Controls movement
  if(keys['ArrowLeft'] || touchLeft) car.speedX = -4;
  else if(keys['ArrowRight'] || touchRight) car.speedX = 4;
  else car.speedX = 0;

  car.x += car.speedX;
  if(car.x < road.leftX) car.x = road.leftX;
  if(car.x + car.width > road.rightX) car.x = road.rightX - car.width;

  // Draw car
  ctx.fillStyle = '#e63946';
  ctx.fillRect(car.x, car.y, car.width, car.height);

  // Spawn obstacles every 1.2 sec
  if(!lastObstacleSpawn) lastObstacleSpawn = timestamp;
  if(timestamp - lastObstacleSpawn > 1200) {
    spawnObstacle();
    lastObstacleSpawn = timestamp;
  }

  // Move and draw obstacles
  for(let i = obstacles.length -1; i >= 0; i--) {
    obstacles[i].y += 3;
    ctx.fillStyle = '#1d3557';
    ctx.fillRect(obstacles[i].x, obstacles[i].y, obstacles[i].width, obstacles[i].height);

    if(rectsCollide(car, obstacles[i])) {
      return gameOver();
    }
    if(obstacles[i].y > canvas.height) obstacles.splice(i,1);
  }

  // Update score
  score++;
  scoreDiv.textContent = `Score: ${score}`;

  animationId = requestAnimationFrame(gameLoop);
}

async function saveScore(name, score) {
  if (!name || typeof score !== "number" || score <= 0) {
    console.warn("Invalid save parameters", {name, score});
    return;
  }
  const scoresRef = ref(db, 'scores');
  await set(push(scoresRef), { name, score, timestamp: Date.now() });
}

async function loadLeaderboard() {
  const scoresRef = query(ref(db, 'scores'), orderByChild('score'), limitToLast(20));
  const snapshot = await get(scoresRef);
  leaderboardList.innerHTML = '';
  const data = [];
  snapshot.forEach(child => {
    const val = child.val();
    if (val && typeof val.score === "number") data.push(val);
  });
  data.sort((a,b) => b.score - a.score);
  if(data.length === 0) {
    leaderboardList.innerHTML = '<li>No results yet</li>';
    return;
  }
  data.forEach((entry,i) => {
    let date = new Date(entry.timestamp).toLocaleString();
    let li = document.createElement('li');
    li.textContent = `${i+1}. ${entry.name} ‚Äî ${entry.score} pts (${date})`;
    leaderboardList.appendChild(li);
  });
}

function gameOver() {
  gameRunning = false;
  cancelAnimationFrame(animationId);
  if(score > 0) {
    saveScore(username, score).then(() => {
      gameDiv.classList.remove('active');
      leaderboardDiv.classList.add('active');
      loadLeaderboard();
    });
  } else {
    gameDiv.classList.remove('active');
    leaderboardDiv.classList.add('active');
    loadLeaderboard();
  }
}

loginBtn.onclick = () => {
  let val = usernameInput.value.trim();
  if(val.length < 2) return alert('Enter name with at least 2 characters');
  username = val;
  loginDiv.classList.remove('active');
  gameDiv.classList.add('active');
  leaderboardDiv.classList.remove('active');
  score = 0;
  obstacles.length = 0;
  car.x = 165;
  gameRunning = true;
  animationId = requestAnimationFrame(gameLoop);
};

finishBtn.onclick = () => { if(gameRunning) gameOver(); };
playAgainBtn.onclick = () => {
  leaderboardDiv.classList.remove('active');
  loginDiv.classList.add('active');
  usernameInput.value = '';
};
</script>

</body>
</html>